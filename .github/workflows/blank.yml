name: Update TV Source File

on:
  schedule:
    # åŒ—äº¬æ—¶é—´ 09:00 = UTC 01:00
    - cron: '10 1 * * *'
    # åŒ—äº¬æ—¶é—´ 17:00 = UTC 09:00  
    - cron: '10 9 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-file:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
    - name: Prepare directory
      run: |
        mkdir -p tv
        echo "åˆ›å»º tv ç›®å½•..."
        
    - name: Test URL with verbose output
      run: |
        echo "=== æµ‹è¯•URLè®¿é—® ==="
        REMOTE_URL="https://my9.ltd/tv/pllive.txt"
        
        echo "1. ä½¿ç”¨curlæµ‹è¯•HTTPå¤´:"
        curl -I -L \
          -H "User-Agent: Mozilla/5.0" \
          --max-time 30 \
          "$REMOTE_URL" 2>&1 | head -20 || echo "curlå¤±è´¥"
          
        echo ""
        echo "2. ä¸‹è½½å‰10Kæµ‹è¯•å†…å®¹:"
        curl -s -L \
          -H "User-Agent: curl/8.8.0" \
          --max-time 30 \
          --range 0-10240 \
          "$REMOTE_URL" | head -c 500 && echo "..."
          
    - name: Download TV source file
      id: download
      run: |
        echo "å¼€å§‹ä¸‹è½½ç›´æ’­æºæ–‡ä»¶..."
        
        REMOTE_URL="https://my9.ltd/tv/pllive.txt"
        LOCAL_PATH="tv/pllive.txt"
        TEMP_FILE="pllive_temp.txt"
        
        echo "ç›®æ ‡URL: $REMOTE_URL"
        echo "ä¿å­˜è·¯å¾„: $LOCAL_PATH"
        
        # æ¸…ç©ºä¸´æ—¶æ–‡ä»¶
        rm -f "$TEMP_FILE" "$LOCAL_PATH"
        
        # æ–¹æ³•1: ä½¿ç”¨ä¸æœ¬åœ°æµ‹è¯•å®Œå…¨ç›¸åŒçš„å‚æ•°
        echo ""
        echo "=== æ–¹æ³•1: å®Œå…¨æ¨¡ä»¿æœ¬åœ°æµ‹è¯• ==="
        curl -v -L \
          -o "$TEMP_FILE" \
          -H "User-Agent: curl/8.8.0" \
          -H "Accept: */*" \
          --max-time 60 \
          "$REMOTE_URL" 2>&1 | grep -E "HTTP/|Content-Type|Content-Length|Server" | head -10 || true
        
        if [ -f "$TEMP_FILE" ]; then
          FILE_SIZE=$(wc -c < "$TEMP_FILE" 2>/dev/null || echo 0)
          echo "ä¸‹è½½æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
          
          if [ $FILE_SIZE -gt 1000 ]; then
            echo "æ–‡ä»¶å¤§å°çœ‹èµ·æ¥æ­£å¸¸"
            
            # æ˜¾ç¤ºæ–‡ä»¶å¼€å¤´å†…å®¹
            echo "æ–‡ä»¶å¼€å¤´50ä¸ªå­—ç¬¦:"
            head -c 50 "$TEMP_FILE" && echo ""
            
            # æ”¾å®½å†…å®¹éªŒè¯æ¡ä»¶
            if head -c 100 "$TEMP_FILE" | grep -q -E "MoMoæ›´æ–°|#genre#|#EXTM3U|ä¸Šæµ·ç”µä¿¡|http://|https://|rtp://"; then
              echo "âœ… å†…å®¹éªŒè¯é€šè¿‡ - åŒ…å«ç›´æ’­æºç‰¹å¾"
              mv "$TEMP_FILE" "$LOCAL_PATH"
              echo "downloaded=true" >> $GITHUB_OUTPUT
              echo "method=curl_exact" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ å†…å®¹éªŒè¯å¤±è´¥ï¼Œæ˜¾ç¤ºè¯¦ç»†å†…å®¹:"
              echo "================================="
              head -c 200 "$TEMP_FILE"
              echo ""
              echo "================================="
              
              # å¦‚æœæ˜¯å°æ–‡ä»¶ï¼Œæ˜¾ç¤ºå…¨éƒ¨å†…å®¹
              if [ $FILE_SIZE -lt 5000 ]; then
                echo "å®Œæ•´æ–‡ä»¶å†…å®¹:"
                cat "$TEMP_FILE"
              fi
              
              # ä½†ä¾ç„¶ä¿å­˜æ–‡ä»¶ç”¨äºè°ƒè¯•
              mv "$TEMP_FILE" "$LOCAL_PATH"
              echo "âš ï¸ å†…å®¹éªŒè¯å¤±è´¥ä½†ä¿å­˜æ–‡ä»¶ç”¨äºè°ƒè¯•"
              echo "downloaded=true" >> $GITHUB_OUTPUT
              echo "method=curl_exact_with_warning" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ æ–‡ä»¶å¤ªå°ï¼Œå¯èƒ½ä¸‹è½½å¤±è´¥"
            rm -f "$TEMP_FILE"
          fi
        else
          echo "âŒ æ–‡ä»¶ä¸‹è½½å¤±è´¥"
        fi
        
        # æ–¹æ³•2: å°è¯•ä¸åŒçš„User-Agent
        if [ ! -f "$LOCAL_PATH" ] || [ ! -s "$LOCAL_PATH" ]; then
          echo ""
          echo "=== æ–¹æ³•2: å°è¯•æµè§ˆå™¨User-Agent ==="
          
          USER_AGENTS=(
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/121.0"
            "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Safari/605.1.15"
          )
          
          for UA in "${USER_AGENTS[@]}"; do
            echo ""
            echo "å°è¯• User-Agent: $(echo $UA | cut -c1-50)..."
            
            curl -s -L \
              -o "$TEMP_FILE" \
              -H "User-Agent: $UA" \
              -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8" \
              -H "Accept-Language: zh-CN,zh;q=0.9" \
              -H "Referer: https://my9.ltd/" \
              --max-time 45 \
              "$REMOTE_URL"
              
            if [ -f "$TEMP_FILE" ] && [ -s "$TEMP_FILE" ]; then
              FILE_SIZE=$(wc -c < "$TEMP_FILE")
              echo "ä¸‹è½½å¤§å°: $FILE_SIZE å­—èŠ‚"
              
              if [ $FILE_SIZE -gt 50000 ]; then  # æœŸæœ›çš„æ–‡ä»¶å¾ˆå¤§
                echo "âœ… å¯èƒ½ä¸‹è½½æˆåŠŸï¼Œæ–‡ä»¶å¤§å°åˆç†"
                mv "$TEMP_FILE" "$LOCAL_PATH"
                echo "downloaded=true" >> $GITHUB_OUTPUT
                echo "method=ua_$(echo $UA | cut -d' ' -f1 | tr -d '()')" >> $GITHUB_OUTPUT
                break
              fi
            fi
            sleep 1
          done
        fi
        
        # æœ€ç»ˆæ£€æŸ¥
        if [ -f "$LOCAL_PATH" ] && [ -s "$LOCAL_PATH" ]; then
          FINAL_SIZE=$(wc -c < "$LOCAL_PATH")
          FINAL_LINES=$(wc -l < "$LOCAL_PATH" 2>/dev/null || echo 0)
          
          echo ""
          echo "=== æœ€ç»ˆç»“æœ ==="
          echo "æ–‡ä»¶è·¯å¾„: $LOCAL_PATH"
          echo "æ–‡ä»¶å¤§å°: $FINAL_SIZE å­—èŠ‚"
          echo "æ–‡ä»¶è¡Œæ•°: $FINAL_LINES è¡Œ"
          
          echo "å‰3è¡Œå†…å®¹:"
          head -3 "$LOCAL_PATH" 2>/dev/null || echo "æ— æ³•è¯»å–æ–‡ä»¶"
        else
          echo ""
          echo "âŒ æ‰€æœ‰ä¸‹è½½æ–¹æ³•éƒ½å¤±è´¥"
          
          # åˆ›å»ºç©ºæ–‡ä»¶å ä½
          echo "# ç›´æ’­æºæ–‡ä»¶ä¸‹è½½å¤±è´¥ - $(date)" > "$LOCAL_PATH"
          echo "# è¯·æ£€æŸ¥URL: $REMOTE_URL" >> "$LOCAL_PATH"
          echo "âš ï¸ åˆ›å»ºäº†å ä½æ–‡ä»¶"
          echo "downloaded=true" >> $GITHUB_OUTPUT
          echo "method=placeholder" >> $GITHUB_OUTPUT
        fi
        
    - name: Check if file changed
      id: check-change
      if: steps.download.outputs.downloaded == 'true'
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶å˜åŒ–..."
        
        FILE_PATH="tv/pllive.txt"
        
        if [ ! -f "$FILE_PATH" ]; then
          echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨"
          echo "has_change=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # ä½¿ç”¨ç®€å•çš„å¤§å°æ¯”è¾ƒ
        CURRENT_SIZE=$(wc -c < "$FILE_PATH" 2>/dev/null || echo 0)
        echo "å½“å‰æ–‡ä»¶å¤§å°: $CURRENT_SIZE å­—èŠ‚"
        
        if git ls-files "$FILE_PATH" >/dev/null 2>&1; then
          # è·å–Gitä¸­çš„æ–‡ä»¶å¤§å°
          GIT_SIZE=$(git cat-file -s :"$FILE_PATH" 2>/dev/null || echo 0)
          echo "Gitä¸­æ–‡ä»¶å¤§å°: $GIT_SIZE å­—èŠ‚"
          
          if [ $CURRENT_SIZE -eq $GIT_SIZE ] && [ $CURRENT_SIZE -gt 100 ]; then
            # å¦‚æœå¤§å°ç›¸åŒä¸”æ–‡ä»¶è¾ƒå¤§ï¼Œè¿›ä¸€æ­¥æ£€æŸ¥å†…å®¹
            CURRENT_HASH=$(md5sum "$FILE_PATH" | cut -d' ' -f1)
            GIT_HASH=$(git hash-object "$FILE_PATH")
            
            if [ "$CURRENT_HASH" = "$GIT_HASH" ]; then
              echo "æ–‡ä»¶æ— å˜åŒ–"
              echo "has_change=false" >> $GITHUB_OUTPUT
            else
              echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ– (å“ˆå¸Œä¸åŒ)"
              echo "has_change=true" >> $GITHUB_OUTPUT
            fi
          elif [ $CURRENT_SIZE -ne $GIT_SIZE ]; then
            echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ– (å¤§å°ä¸åŒ)"
            echo "has_change=true" >> $GITHUB_OUTPUT
          else
            echo "æ–‡ä»¶å¯èƒ½ä¸ºç©ºæˆ–æ— æ•ˆ"
            echo "has_change=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "æ–‡ä»¶æœªè¢«Gitè·Ÿè¸ªï¼Œæ˜¯æ–°æ–‡ä»¶"
          echo "has_change=true" >> $GITHUB_OUTPUT
        fi
        
    - name: Commit and push changes
      if: steps.check-change.outputs.has_change == 'true'
      run: |
        echo "å‡†å¤‡æäº¤æ–‡ä»¶..."
        
        FILE_PATH="tv/pllive.txt"
        
        if [ ! -f "$FILE_PATH" ]; then
          echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•æäº¤"
          exit 1
        fi
        
        FILE_SIZE=$(wc -c < "$FILE_PATH")
        FILE_LINES=$(wc -l < "$FILE_PATH" 2>/dev/null || echo 0)
        FILE_MD5=$(md5sum "$FILE_PATH" | cut -d' ' -f1 2>/dev/null || echo "unknown")
        METHOD="${{ steps.download.outputs.method }}"
        
        echo "=== æäº¤ä¿¡æ¯ ==="
        echo "æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
        echo "æ–‡ä»¶è¡Œæ•°: $FILE_LINES è¡Œ"
        echo "æ–‡ä»¶MD5: $FILE_MD5"
        echo "ä¸‹è½½æ–¹æ³•: $METHOD"
        
        git add "$FILE_PATH"
        
        # æäº¤ä¿¡æ¯
        COMMIT_MSG="ğŸ“º æ›´æ–°ç›´æ’­æº - $(date '+%Y-%m-%d %H:%M UTC')"
        COMMIT_MSG="$COMMIT_MSG | å¤§å°: ${FILE_SIZE}å­—èŠ‚"
        
        if [ $FILE_LINES -gt 0 ]; then
          COMMIT_MSG="$COMMIT_MSG | è¡Œæ•°: ${FILE_LINES}è¡Œ"
        fi
        
        COMMIT_MSG="$COMMIT_MSG | æ–¹æ³•: ${METHOD}"
        
        git commit -m "$COMMIT_MSG"
        
        echo "æ¨é€åˆ°GitHub..."
        git push
        
        echo "âœ… æäº¤å¹¶æ¨é€å®Œæˆ"
        
    - name: Show detailed final status
      run: |
        echo "=========================================="
        echo "          è¯¦ç»†æ‰§è¡ŒæŠ¥å‘Š"
        echo "=========================================="
        
        echo "æ‰§è¡Œå®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "å¯¹åº”åŒ—äº¬æ—¶é—´: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
        
        echo ""
        echo "ğŸ“ ç›®å½•ç»“æ„:"
        find . -name "*.txt" -type f | head -20
        
        echo ""
        if [ -f "tv/pllive.txt" ]; then
          echo "âœ… ç›®æ ‡æ–‡ä»¶å­˜åœ¨"
          echo "æ–‡ä»¶ä¿¡æ¯:"
          ls -lh "tv/pllive.txt"
          
          echo ""
          echo "ğŸ“Š å†…å®¹åˆ†æ:"
          FILE_SIZE=$(wc -c < "tv/pllive.txt")
          echo "æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
          
          if [ $FILE_SIZE -lt 2000 ]; then
            echo "âš ï¸ è­¦å‘Š: æ–‡ä»¶å¾ˆå°ï¼Œå¯èƒ½ä¸æ˜¯æœ‰æ•ˆçš„ç›´æ’­æº"
            echo "å®Œæ•´å†…å®¹:"
            echo "----------------------------------------"
            cat "tv/pllive.txt"
            echo "----------------------------------------"
          else
            echo "å†…å®¹é¢„è§ˆ (å‰10è¡Œ):"
            echo "----------------------------------------"
            head -10 "tv/pllive.txt"
            echo "----------------------------------------"
            
            # ç»Ÿè®¡ä¿¡æ¯
            echo ""
            echo "ğŸ”¢ ç»Ÿè®¡ä¿¡æ¯:"
            echo "æ€»è¡Œæ•°: $(wc -l < "tv/pllive.txt" 2>/dev/null || echo "N/A")"
            echo "HTTPé“¾æ¥æ•°: $(grep -c "http://" "tv/pllive.txt" 2>/dev/null || echo "0")"
            echo "HTTPSé“¾æ¥æ•°: $(grep -c "https://" "tv/pllive.txt" 2>/dev/null || echo "0")"
          fi
        else
          echo "âŒ ç›®æ ‡æ–‡ä»¶ä¸å­˜åœ¨"
        fi
        
        echo ""
        echo "ğŸ” ç½‘ç»œè¯Šæ–­å»ºè®®:"
        echo "1. æ‰‹åŠ¨è®¿é—®: https://my9.ltd/tv/pllive.txt"
        echo "2. æ£€æŸ¥æ˜¯å¦è¢«æœåŠ¡å™¨å±è”½"
        echo "3. å°è¯•ä¸åŒçš„User-Agent"
        echo "4. è€ƒè™‘ä½¿ç”¨ä»£ç†æœåŠ¡å™¨"
        
        echo ""
        echo "â° ä¸‹æ¬¡è‡ªåŠ¨æ‰§è¡Œ: æ¯å¤© UTC 22:00 (åŒ—äº¬æ—¶é—´ 06:00)"
